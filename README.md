# Telegram Chat Members Export Bot

Бот принимает файлы экспорта истории чата из Telegram, извлекает список уникальных участников (авторы сообщений + упоминания) и каналы, и формирует:
- если участников < 50: список `@username` прямо в чат;
- если участников ≥ 51: Excel-файл с вкладками и структурой, указанной в ТЗ.

Основные принципы:
- Обработка «на лету» — бот не сохраняет файлы и персональные данные на сервере (кроме оперативной памяти);
- Корректная работа с кодировками и широким спектром форматов экспорта Telegram: JSON, HTML, ZIP (официальный экспорт Telegram Desktop/Mobile);
- Разделение участников, упоминаний и каналов по вкладкам в Excel.

## Возможности

1. Приём истории чата
   - Принимает один или несколько файлов (ограничение Telegram: до ~10 файлов за один медиа-альбом/пакет отправки, но допускает последовательную отправку большего числа).
   - Поддерживаемые форматы: `.json`, `.html`, `.zip` (официальный экспорт Telegram).
2. Извлечение участников
   - Находит пользователей:
     - авторы сообщений;
     - упомянутые в тексте `@username`.
   - Исключает:
     - удалённые аккаунты (username типа `Deleted Account` или отсутствует идентификатор/username);
     - дубли (один пользователь — один раз).
3. Формирование результата
   - < 50 участников: отправка списка в чат.
   - ≥ 51 участников: формирование Excel (вклады: "Участники", "Упоминания", "Каналы").
4. Структура Excel
   - Поля:
     - Дата экспорта
     - Username
     - Имя и фамилия
     - Описание (Bio/About, если доступно в экспорте)
     - Дата регистрации (если доступно)
     - Наличие канала в профиле (эвристика, и/или если запись в экспорте помечена как канал)
5. Корректная обработка файлов и кодировок
   - Автоопределение кодировки, нормализация текста, устойчивость к смешанным кодировкам в HTML.
6. Конфиденциальность
   - Никакого сохранения на диск (кроме временных буферов в памяти);
   - Одноразовая обработка входных данных; по завершении сборов — очистка структур данных.

## Архитектура

- `app/main.py` — точка входа бота (aiogram v3): обработка команд и документов.
- `app/processing/parser.py` — универсальный парсер экспорта Telegram (JSON/HTML/ZIP).
- `app/processing/extractor.py` — извлечение сущностей (участники, упоминания, каналы).
- `app/processing/excel.py` — генерация Excel-файла (openpyxl) и подготовка вкладок.
- `app/utils/temp.py` — временные буферы в памяти, контроль объёма и очистка.
- `Dockerfile` — образ приложения.
- `docker-compose.yml` — запуск бота.
- `config.example.env` — пример переменных окружения.

Диаграмма потоков:
1. Пользователь отправляет 1..N файлов экспорта -> бот аккумулирует их в сессии (по chat_id / user_id).
2. По команде `/process` или после получения всех файлов — запускается парсинг.
3. Парсер — распаковка ZIP (если нужно), поиск `result.json` / `messages.html` / иных типичных имен.
4. Экстрактор — извлекает:
   - Список авторов сообщений (username, имя/фамилия, bio если есть);
   - Упоминания `@username` в тексте;
   - Каналы (сообщения, где `type` канал/forwarded from channel).
5. Нормализация, фильтрация удалённых аккаунтов, устранение дубликатов.
6. Если <50 — отправка текстового списка; иначе — генерация Excel в памяти и отправка.
7. Очистка временных данных.

## Запуск (Docker)

1. Склонировать репозиторий.
2. Создать `.env` на основе `config.example.env`:
   ```
   cp config.example.env .env
   ```
   Заполнить `BOT_TOKEN` (получите у [BotFather](https://t.me/BotFather)).
3. Запуск:
   ```
   docker compose up --build
   ```

Бот запустится и будет готов к приёму файлов.

## Команды бота

- `/start` — краткая справка.
- `/help` — помощь и о формате экспорта.
- Отправка файлов (JSON/HTML/ZIP) — бот принимает, аккумулирует.
- `/process` — выполнить обработку загруженных файлов (если вы отправляете порциями).

Примечание: Telegram имеет лимиты на число файлов, отправляемых за раз. Рекомендуем не более 10 файлов одним сообщением, при необходимости — отправлять несколькими сообщениями. Бот принимает последовательные отправки и аккумулирует их.

## Пример выгрузки

В каталоге `examples/` могут быть размещены:
- `example.xlsx` — демонстрационный Excel.
- Скриншоты работы бота.

## Ограничения и заметки

- Дата регистрации и Bio/About доступны только если присутствуют в экспорте (Telegram часто не включает эти поля для всех участников).
- Наличие канала в профиле — эвристическое поле: может быть определено по метаданным forward/from/channel или по типам автора в экспорте.
- Бот не получает доступ к "списку участников" через API Telegram — он работает сугубо с контентом экспорта.
- Скорость обработки зависит от размера экспорта; при больших архивах первое формирование может занять время.

## Лицензия

MIT